---
output:
  word_document: default
  pdf_document:
    fig_caption: yes
    latex_engine: xelatex
  html_document: default
---


# Workflow {#workflow}

- **Data Preparation**: Download monthly [NHS prescription datasets][NHSBSA] and Dictionary of medicines and devices release files [(dm+d)][dm+d].
- **Data Conversion**: Aggregation and conversion of the locally stored datasets into practice wise dataset achieved using the functions in `PrAna`.
- **Visualise and Analyse the data**: Visualise and analyse the processed dataset using the in-built ShinyApp `PrAnaViz`.
- **Database service**: Linking of the processed dataset to the `PrAnaViz` can be achieved by uploading the processed dataset to a local or a remote database service, for example, [_MySQL._][MySQL]
- **Download images and processed data**: Users can download processed data as **_.csv_** file and publication ready image **_.eps_** and **_.pdf_** files.


```{r prana-workflow, echo=FALSE, out.width='80%', fig.align='center', fig.fullwidth=TRUE, fig.cap='PrAna Workflow.'}
knitr::include_graphics('figures/fig-workflow.png')
```


## Data Preparation

To download NHS prescription datasets \@ref(fig:prana-workflow), users need to guest login and solve a captcha in [NHSBSA information portal][NHSBSA], to download the [dm+d][dm+d] release files and [_dm+d XML Transformation Tool_][dm+d2], users need to register an account.

Store the monthly NHS prescription data in year wise folder. For an example, store all the 2015 monthly datasets in a folder named '2015'. Extract the _dm+d release files_ using _dm+d XML Transformation Tool_. The documentation to extract the release file using the tool is well explained in the readme file.


## Data Conversion

Different functions were used in the aggregation and conversion workflow behind the scenes that performs the heavy lifting of a workflow step and finally return the results. 

An overview of all functions involved in the data conversion is shown in the table below.

Function         | Remarks
-----------------| ----------------------------------------------
`csv2dat()`   | Combine and convert all the comma separated value (.CSV) files in the defined file path and export it into a single R object
`importdmd()`  | Import dm+d files and link it to the BNF code using the SNOMED mapping file
`uk_practice_wise()` | Import NHS dataset files and generate processed individual GP practice prescription dataset

`csv2dat()` function supports to combine different monthly NHS prescription dataset files into a single `.rds` file to process further. For an example:

```
## Set the folder to store the combined file
setwd("C:/Datasets/2018")

## Combine and convert mulitple files in the defined folder to a dataframe

data201812 <- csv2dat("C:/Datasets/Prescription Datasets/2018/PDPI")

```
After successful conversion of the monthly files into a single dataframe, `importdmd()` function helps to breakdown each row of this dataframe into an API, with its corresponding strength and medicinal form by its BNF Code.

Before this step, user need to execute to import different `dm+d files` and multiple data objects  linking each API to its BNF Code, strength and medicinal form. For example:

```
## Read the extracted files
dmdfile  <- importdmd("C:/dmdDataLoader/excel/")

bnf_full_final <- dmdfile$bnf_full_final
uom <- dmdfile$uom
dform <- dmdfile$dform
ing <- dmdfile$ing


```


[NHSBSA]: https://applications.nhsbsa.nhs.uk/infosystems/welcome
[dm+d]: https://isd.digital.nhs.uk/trud3/user/guest/group/0/pack/6
[dm+d2]: https://isd.digital.nhs.uk/trud3/user/guest/group/0/pack/6/subpack/239/releases